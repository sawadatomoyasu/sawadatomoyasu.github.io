<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>心的回転</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
  }
  .pair-container {
    display: none;
    justify-content: center;
    align-items: center;
    margin-top: 120px;
  }
  .img-box {
    width: 300px;
    height: 300px;
    margin: 0 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #fff;
  }
  .img-box img {
    max-width: 95%;
    max-height: 95%;
    transform-origin: center center;
  }

  #instruction-screen,
  #break-screen,
  #fixation,
  #feedback,
  #end-message {
    margin-top: 180px;
    font-size: 32px;
    line-height: 1.8;
  }

  #fixation {
    font-size: 72px;
  }
  #feedback {
    font-size: 80px;
  }

  #end-message {
    display: none;
  }

  /* ★ 追加：休憩・終了画面 → 黒背景＋白文字 */
  #break-screen,
  #end-message {
    background-color: #000;
    color: #fff;
    margin-top: 0;
    padding-top: 40px 0;
    min-height: 0vh;
  }

  /* ★ 追加：結果画面も黒背景＋白文字 */
  #result-section {
    display: none;
    margin-top: 50px;
    background-color: #000;  /* 黒背景 */
    color: #fff;             /* 白文字 */
    min-height: 100vh;       /* 全画面の黒背景 */
    padding-top: 100px;
  }

  table {
    width: 80%;
    margin: 0 auto;
    border-collapse: collapse;
  }

  /* ★ 追加：表の線を白にして黒背景で見えるようにする */
  table, th, td {
    border: 1px solid #fff;
  }

  th, td {
    padding: 8px;
  }

  #copy-btn {
    margin-bottom: 20px;
    padding: 10px 20px;
    font-size: 18px;
  }
</style>
</head>

<body>

<div id="instruction-screen">
  左右に二枚呈示される画像が一致していれば“j”，<br>
  鏡像であれば“h”または“m”を，出来る限り早く正確に押してください<br><br>
  準備ができたら，“h/m” または “j” を押して始めてください<br><br>
  ※画像は Nishimoto et al.（2014）より使用
</div>

<div id="break-screen" style="display:none;">
  休憩してください。<br><br>
  十分に休憩できたら，“h/m” または “j” を押して再開してください
</div>

<div id="fixation" style="display:none;">
  ＋
</div>

<div class="pair-container" id="pair">
  <div class="img-box">
    <img id="left-img" src="" alt="left">
  </div>
  <div class="img-box">
    <img id="right-img" src="" alt="right">
  </div>
</div>

<div id="feedback" style="display:none;"></div>

<div id="end-message">すべての刺激の呈示が終了しました</div>

<!-- ★ 黒背景領域に入る結果画面 -->
<div id="result-section">
  <button id="copy-btn">結果をコピー</button>
  <table id="result-table">
    <thead>
      <tr>
        <th>試行</th>
        <th>反転</th>
        <th>角度</th>
        <th>正誤</th>
        <th>反応時間(ms)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// ------------------ 刺激リスト作成 ------------------
const files = [];
for (let i = 1; i <= 360; i++) {
  files.push(String(i).padStart(3, "0") + ".png");
}

// preload
let preloadImages = [];
files.forEach(f => {
  const img1 = new Image();
  img1.src = "Nishimoto_2012/" + f;
  preloadImages.push(img1);

  const img2 = new Image();
  img2.src = "Nishimoto_2012_flipped/" + f;
  preloadImages.push(img2);
});

// angles
const angleLevels = [45, 90, 135, 180, 225, 270, 315, 360];
const angles = [];
angleLevels.forEach(a => {
  for (let i = 0; i < 45; i++) angles.push(a);
});

// shuffle
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// right normal trials
let rightIsNormal = new Array(360).fill(false);
let indices = [...Array(360).keys()];
shuffle(indices);
for (let i = 0; i < 180; i++) rightIsNormal[indices[i]] = true;

// trial list
let trials = [];
for (let i = 0; i < 360; i++) {
  trials.push({
    file: files[i],
    angle: angles[i],
    rightNormal: rightIsNormal[i]
  });
}

shuffle(trials);

// 状態管理
let currentIndex = 0;
let trialStartTime = performance.now();
let results = [];
let phase = "instruction";

// 表示処理など…（前回と同じ）
// ------------------ ここから省略せずそのまま ------------------

function showCurrentPair() {
  const trial = trials[currentIndex];
  const leftImg = document.getElementById("left-img");
  const rightImg = document.getElementById("right-img");

  leftImg.src = "Nishimoto_2012/" + trial.file;
  leftImg.style.transform = "rotate(0deg)";

  rightImg.src = trial.rightNormal
    ? "Nishimoto_2012/" + trial.file
    : "Nishimoto_2012_flipped/" + trial.file;

  rightImg.style.transform = "rotate(" + trial.angle + "deg)";
}

function startFixation() {
  if (currentIndex >= trials.length) {
    finishExperiment();
    return;
  }
  phase = "fixation";

  document.getElementById("instruction-screen").style.display = "none";
  document.getElementById("break-screen").style.display = "none";
  document.getElementById("pair").style.display = "none";
  document.getElementById("feedback").style.display = "none";

  const fixation = document.getElementById("fixation");
  fixation.style.display = "block";

  const duration = 1000 + Math.random() * 1000;
  setTimeout(() => {
    if (phase === "fixation") {
      showStimulus();
    }
  }, duration);
}

function showStimulus() {
  if (currentIndex >= trials.length) {
    finishExperiment();
    return;
  }
  phase = "stimulus";

  document.getElementById("fixation").style.display = "none";
  document.getElementById("feedback").style.display = "none";

  showCurrentPair();
  document.getElementById("pair").style.display = "flex";

  trialStartTime = performance.now();
}

function showFeedback(isCorrect) {
  phase = "feedback";

  document.getElementById("pair").style.display = "none";
  const fb = document.getElementById("feedback");
  fb.textContent = isCorrect ? "〇" : "×";
  fb.style.display = "block";

  setTimeout(() => {
    currentIndex++;
    if (currentIndex < trials.length && currentIndex % 120 === 0) {
      showBreak();
    } else {
      startFixation();
    }
  }, 500);
}

function showBreak() {
  phase = "break";
  document.getElementById("feedback").style.display = "none";
  document.getElementById("fixation").style.display = "none";
  document.getElementById("pair").style.display = "none";
  document.getElementById("break-screen").style.display = "block";
}

function finishExperiment() {
  phase = "finished";

  document.getElementById("fixation").style.display = "none";
  document.getElementById("pair").style.display = "none";
  document.getElementById("feedback").style.display = "none";
  document.getElementById("break-screen").style.display = "none";
  document.getElementById("instruction-screen").style.display = "none";

  document.getElementById("end-message").style.display = "block";
  document.getElementById("result-section").style.display = "block";

  const tbody = document.querySelector("#result-table tbody");

  results.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.trial}</td>
      <td>${r.inversion}</td>
      <td>${r.angle}</td>
      <td>${r.accuracy}</td>
      <td>${r.rt}</td>
    `;
    tbody.appendChild(row);
  });
}

document.addEventListener("keydown", function(e) {
  const key = e.key.toLowerCase();

  if (key !== "j" && key !== "h" && key !== "m") return;

  if (phase === "instruction") {
    startFixation();
    return;
  }

  if (phase === "break") {
    startFixation();
    return;
  }

  if (phase === "stimulus") {
    const rt = performance.now() - trialStartTime;
    const trial = trials[currentIndex];

    const inversion = trial.rightNormal ? "無し" : "有り";

    let isCorrect;
    if (trial.rightNormal) {
      isCorrect = (key === "j");
    } else {
      isCorrect = (key === "h" || key === "m");
    }

    const accuracy = isCorrect ? "正" : "誤";

    results.push({
      trial: currentIndex + 1,
      inversion,
      angle: trial.angle,
      accuracy,
      rt: Math.round(rt)
    });

    showFeedback(isCorrect);
    return;
  }
});

document.getElementById("copy-btn").addEventListener("click", function() {
  let text = "試行\t反転\t角度\t正誤\t反応時間(ms)\n";
  results.forEach(r => {
    text += `${r.trial}\t${r.inversion}\t${r.angle}\t${r.accuracy}\t${r.rt}\n`;
  });

  navigator.clipboard.writeText(text).then(() => {
    alert("結果をコピーしました！");
  });
});
</script>

</body>
</html>

