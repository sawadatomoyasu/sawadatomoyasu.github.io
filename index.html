<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Nishimoto Image Pair Task (Full)</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
  }
  .pair-container {
    display: none; /* 最初は非表示 */
    justify-content: center;
    align-items: center;
    margin-top: 120px;
  }
  .img-box {
    width: 300px;
    height: 300px;
    margin: 0 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #fff;
  }
  .img-box img {
    max-width: 95%;
    max-height: 95%;
    transform-origin: center center;
  }

  #instruction-screen,
  #break-screen,
  #fixation,
  #feedback,
  #end-message {
    margin-top: 180px;
    font-size: 32px;
    line-height: 1.8;
  }

  #fixation {
    font-size: 72px;
  }
  #feedback {
    font-size: 80px;
  }

  #end-message {
    display: none;
  }

  #result-section {
    display: none;
    margin-top: 50px;
  }
  table {
    width: 80%;
    margin: 0 auto;
    border-collapse: collapse;
  }
  table, th, td {
    border: 1px solid #666;
  }
  th, td {
    padding: 8px;
  }
  #copy-btn {
    margin-bottom: 20px;
    padding: 10px 20px;
    font-size: 18px;
  }
</style>
</head>

<body>

<!-- 開始画面 -->
<div id="instruction-screen">
  左右に二枚呈示される画像が一致していれば“j”，<br>
  鏡像であれば“f”を，出来る限り早く正確に押してください。<br><br>
  なお，左の画像は常に成立していますが，<br>
  右の画像は角度が変わります。<br><br>
  準備ができたら，“f”または“j”のキーを押して始めてください。<br><br>
  ※画像は Nishimoto et al., 2014
</div>

<!-- 休憩画面 -->
<div id="break-screen" style="display:none;">
  休憩してください。<br><br>
  十分に休憩できたら，“f”または“j”のキーを押して始めてください。
</div>

<!-- 固視点（＋） -->
<div id="fixation" style="display:none;">
  ＋
</div>

<!-- 刺激呈示 -->
<div class="pair-container" id="pair">
  <div class="img-box">
    <img id="left-img" src="" alt="left">
  </div>
  <div class="img-box">
    <img id="right-img" src="" alt="right">
  </div>
</div>

<!-- フィードバック（〇／×） -->
<div id="feedback" style="display:none;"></div>

<div id="end-message">すべての刺激の呈示が終了しました。</div>

<!-- 結果表示セクション -->
<div id="result-section">
  <button id="copy-btn">結果をコピー</button>
  <table id="result-table">
    <thead>
      <tr>
        <th>試行</th>
        <th>反転</th>
        <th>角度</th>
        <th>正誤</th>
        <th>反応時間(ms)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// ------------------ 刺激リスト作成 ------------------
const files = [];
for (let i = 1; i <= 360; i++) {
  files.push(String(i).padStart(3, "0") + ".png");
}

// ===== ここから事前読み込み（preload） =====
let preloadImages = [];
files.forEach(f => {
  const img1 = new Image();
  img1.src = "Nishimoto_2012/" + f;
  preloadImages.push(img1);

  const img2 = new Image();
  img2.src = "Nishimoto_2012_flipped/" + f;
  preloadImages.push(img2);
});
// ===== 事前読み込みここまで =====

// 角度（各45回ずつ = 360 試行）
const angleLevels = [45, 90, 135, 180, 225, 270, 315, 360];
const angles = [];
angleLevels.forEach(a => {
  for (let i = 0; i < 45; i++) angles.push(a);
});

// シャッフル関数
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// 右画像が非反転になる試行を 180 個作成
let rightIsNormal = new Array(360).fill(false);
let indices = [...Array(360).keys()];
shuffle(indices);
for (let i = 0; i < 180; i++) rightIsNormal[indices[i]] = true;

// 試行リスト作成
let trials = [];
for (let i = 0; i < 360; i++) {
  trials.push({
    file: files[i],
    angle: angles[i],
    rightNormal: rightIsNormal[i]  // 右が非反転なら true
  });
}

// 試行順をシャッフル
shuffle(trials);

// ------------------ 状態管理 ------------------
let currentIndex = 0;
let trialStartTime = performance.now();
let results = [];
let phase = "instruction";  // instruction / fixation / stimulus / feedback / break / finished

// 刺激（画像）を読み込む：テキストは出さない
function showCurrentPair() {
  const trial = trials[currentIndex];
  const leftImg = document.getElementById("left-img");
  const rightImg = document.getElementById("right-img");

  // 左：常に非反転・無回転
  leftImg.src = "Nishimoto_2012/" + trial.file;
  leftImg.style.transform = "rotate(0deg)";

  // 右：非反転 or 反転フォルダ
  rightImg.src = trial.rightNormal
    ? "Nishimoto_2012/" + trial.file
    : "Nishimoto_2012_flipped/" + trial.file;

  // 右画像のみ回転
  rightImg.style.transform = "rotate(" + trial.angle + "deg)";
}

// 固視点表示 → 1〜2 秒後に刺激へ
function startFixation() {
  if (currentIndex >= trials.length) {
    finishExperiment();
    return;
  }
  phase = "fixation";

  document.getElementById("instruction-screen").style.display = "none";
  document.getElementById("break-screen").style.display = "none";
  document.getElementById("pair").style.display = "none";
  document.getElementById("feedback").style.display = "none";

  const fixation = document.getElementById("fixation");
  fixation.style.display = "block";

  const duration = 1000 + Math.random() * 1000; // 1〜2秒
  setTimeout(() => {
    if (phase === "fixation") {
      showStimulus();
    }
  }, duration);
}

// 刺激呈示フェーズ
function showStimulus() {
  if (currentIndex >= trials.length) {
    finishExperiment();
    return;
  }
  phase = "stimulus";

  document.getElementById("fixation").style.display = "none";
  document.getElementById("feedback").style.display = "none";

  showCurrentPair();
  const pairDiv = document.getElementById("pair");
  pairDiv.style.display = "flex";

  trialStartTime = performance.now();
}

// フィードバック（〇／×）
function showFeedback(isCorrect) {
  phase = "feedback";

  document.getElementById("pair").style.display = "none";
  const fb = document.getElementById("feedback");
  fb.textContent = isCorrect ? "〇" : "×";
  fb.style.display = "block";

  setTimeout(() => {
    currentIndex++;
    // 120 試行ごとに休憩（ただし最終試行後は除く）
    if (currentIndex < trials.length && currentIndex % 120 === 0) {
      showBreak();
    } else {
      startFixation();
    }
  }, 1000); // 1秒間表示
}

// 休憩画面
function showBreak() {
  phase = "break";

  document.getElementById("feedback").style.display = "none";
  document.getElementById("fixation").style.display = "none";
  document.getElementById("pair").style.display = "none";

  document.getElementById("break-screen").style.display = "block";
}

// 実験終了・結果表示
function finishExperiment() {
  phase = "finished";

  document.getElementById("fixation").style.display = "none";
  document.getElementById("pair").style.display = "none";
  document.getElementById("feedback").style.display = "none";
  document.getElementById("break-screen").style.display = "none";
  document.getElementById("instruction-screen").style.display = "none";

  document.getElementById("end-message").style.display = "block";
  document.getElementById("result-section").style.display = "block";

  const tbody = document.querySelector("#result-table tbody");

  results.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.trial}</td>
      <td>${r.inversion}</td>
      <td>${r.angle}</td>
      <td>${r.accuracy}</td>
      <td>${r.rt}</td>
    `;
    tbody.appendChild(row);
  });
}

// ------------------ キー入力 ------------------
document.addEventListener("keydown", function(e) {
  const key = e.key.toLowerCase();
  if (key !== "j" && key !== "f") return;

  if (phase === "instruction") {
    // 開始画面から実験開始
    startFixation();
    return;
  }

  if (phase === "break") {
    // 休憩画面から再開
    startFixation();
    return;
  }

  if (phase === "stimulus") {
    // 反応を記録
    const rt = performance.now() - trialStartTime;
    const trial = trials[currentIndex];

    const inversion = trial.rightNormal ? "無し" : "有り";
    const correctKey = trial.rightNormal ? "j" : "f";
    const accuracy = key === correctKey ? "正" : "誤";

    results.push({
      trial: currentIndex + 1,
      inversion,
      angle: trial.angle,
      accuracy,
      rt: Math.round(rt)
    });

    const isCorrect = (accuracy === "正");
    showFeedback(isCorrect);
    return;
  }

  // fixation / feedback / finished 中のキーは無視
});

// ------------------ 結果コピー機能 ------------------
document.getElementById("copy-btn").addEventListener("click", function() {
  let text = "trial\tinversion\tangle\taccuracy\trt\n";
  results.forEach(r => {
    text += `${r.trial}\t${r.inversion}\t${r.angle}\t${r.accuracy}\t${r.rt}\n`;
  });

  navigator.clipboard.writeText(text).then(() => {
    alert("結果をコピーしました！");
  });
});
</script>

</body>
</html>
